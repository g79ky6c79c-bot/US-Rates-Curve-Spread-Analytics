<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>US Rates Curve & Spread Analytics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0b1020;
            color: #e5e7eb;
        }
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .subtitle {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 16px;
        }
        .panel {
            background: #111827;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #1f2937;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .panel-title {
            font-size: 15px;
            font-weight: 600;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        label {
            display: block;
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 4px;
        }
        select, input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        button {
            padding: 8px 14px;
            border-radius: 4px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-primary:disabled {
            background: #1d3d7b;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #111827;
            color: #e5e7eb;
            border: 1px solid #374151;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }
        .kpi-card {
            background: #020617;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #1f2937;
        }
        .kpi-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        .kpi-value {
            font-size: 18px;
            font-weight: 600;
        }
        .kpi-sub {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 16px;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }
        .status {
            font-size: 12px;
            color: #9ca3af;
        }
        .status-error {
            color: #f97373;
        }
        .badge {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid #374151;
            color: #d1d5db;
        }
        .badge-green {
            border-color: #10b981;
            color: #a7f3d0;
        }
        .badge-red {
            border-color: #ef4444;
            color: #fecaca;
        }
        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>
<div class="app-container">
    <h1>US Rates Curve & Spread Analytics</h1>
    <div class="subtitle">
        Treasury yields, curve fitting (Nelson-Siegel-Svensson), spread statistics, and rate shock scenarios.
    </div>

    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">Configuration</div>
            <div class="status" id="statusText">Idle</div>
        </div>
        <div class="controls-grid">
            <div>
                <label for="shortSelect">Short maturity</label>
                <select id="shortSelect">
                    <option value="2">2Y</option>
                    <option value="5">5Y</option>
                </select>
            </div>
            <div>
                <label for="longSelect">Long maturity</label>
                <select id="longSelect">
                    <option value="10">10Y</option>
                    <option value="30">30Y</option>
                </select>
            </div>
            <div>
                <label for="startInput">Start date</label>
                <input type="date" id="startInput" value="2023-01-01">
            </div>
            <div>
                <label for="endInput">End date</label>
                <input type="date" id="endInput" value="2024-12-01">
            </div>
            <div>
                <label for="shockInput">Shock size (bps)</label>
                <input type="number" id="shockInput" value="10" step="1">
            </div>
            <div>
                <label for="shockTypeSelect">Shock type</label>
                <select id="shockTypeSelect">
                    <option value="none">None</option>
                    <option value="parallel">Parallel</option>
                    <option value="steepener">Steepener</option>
                    <option value="flattener">Flattener</option>
                </select>
            </div>
            <div style="display:flex; align-items:flex-end; gap:8px;">
                <button class="btn-primary" id="runButton">Run analysis</button>
                <button class="btn-secondary" id="resetButton">Reset</button>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">Key Indicators</div>
            <div id="labelsBadge" class="badge">–</div>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Current spread</div>
                <div class="kpi-value" id="kpiSpread">–</div>
                <div class="kpi-sub">bps (long − short)</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Z-score</div>
                <div class="kpi-value" id="kpiZ">–</div>
                <div class="kpi-sub">Deviation from mean</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Percentile</div>
                <div class="kpi-value" id="kpiPct">–</div>
                <div class="kpi-sub">Historical distribution</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">10Y yield</div>
                <div class="kpi-value" id="kpi10Y">–</div>
                <div class="kpi-sub">From fitted curve</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">DV01 proxy</div>
                <div class="kpi-value" id="kpiDV01">–</div>
                <div class="kpi-sub">Per 100 notional</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">Time Series: Yields & Spread</div>
        </div>
        <div class="charts-grid">
            <div>
                <div class="chart-container">
                    <canvas id="yieldsChart"></canvas>
                </div>
            </div>
            <div>
                <div class="chart-container">
                    <canvas id="spreadChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <div class="panel-title">Spot vs Shocked Yield Curve</div>
            <div id="shockBadge" class="badge">No shock</div>
        </div>
        <div class="chart-container">
            <canvas id="curveChart"></canvas>
        </div>
    </div>
</div>

<script>
    const apiUrl = "http://127.0.0.1:5000/api/analyze";

    const statusText = document.getElementById("statusText");
    const runButton = document.getElementById("runButton");
    const resetButton = document.getElementById("resetButton");
    const shortSelect = document.getElementById("shortSelect");
    const longSelect = document.getElementById("longSelect");
    const startInput = document.getElementById("startInput");
    const endInput = document.getElementById("endInput");
    const shockInput = document.getElementById("shockInput");
    const shockTypeSelect = document.getElementById("shockTypeSelect");

    const kpiSpread = document.getElementById("kpiSpread");
    const kpiZ = document.getElementById("kpiZ");
    const kpiPct = document.getElementById("kpiPct");
    const kpi10Y = document.getElementById("kpi10Y");
    const kpiDV01 = document.getElementById("kpiDV01");
    const labelsBadge = document.getElementById("labelsBadge");
    const shockBadge = document.getElementById("shockBadge");

    let yieldsChart, spreadChart, curveChart;

    function createLineChart(ctx, config) {
        return new Chart(ctx, {
            type: "line",
            data: config.data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "index",
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: {
                            color: "#e5e7eb",
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    },
                    tooltip: {
                        mode: "index",
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        ticks: { color: "#9ca3af" },
                        grid: { color: "rgba(55,65,81,0.4)" }
                    },
                    y: {
                        ticks: { color: "#9ca3af" },
                        grid: { color: "rgba(55,65,81,0.4)" }
                    }
                }
            }
        });
    }

    function updateStatus(text, isError = false) {
        statusText.textContent = text;
        statusText.className = "status" + (isError ? " status-error" : "");
    }

    function setLoading(isLoading) {
        runButton.disabled = isLoading;
        if (isLoading) {
            updateStatus("Loading...");
        } else {
            if (!statusText.classList.contains("status-error")) {
                updateStatus("Ready");
            }
        }
    }

    function formatBps(x) {
        if (x === null || x === undefined || isNaN(x)) return "–";
        return x.toFixed(1);
    }

    function formatPct(x) {
        if (x === null || x === undefined || isNaN(x)) return "–";
        return (x * 100).toFixed(2) + "%";
    }

    function formatNum(x, digits = 2) {
        if (x === null || x === undefined || isNaN(x)) return "–";
        return x.toFixed(digits);
    }

    function updateKPIs(data) {
        const stats = data.stats;
        const risk = data.risk;

        kpiSpread.textContent = formatBps(stats.current_spread);
        kpiZ.textContent = formatNum(stats.z_score, 2);
        kpiPct.textContent = formatNum(stats.percentile, 1) + "%";
        kpi10Y.textContent = formatPct(risk.r10);
        kpiDV01.textContent = formatNum(risk.dv01, 3);

        const shortLabel = data.labels.short;
        const longLabel = data.labels.long;
        labelsBadge.textContent = `${shortLabel} vs ${longLabel}`;
        labelsBadge.className = "badge";

        if (stats.current_spread >= stats.mean) {
            labelsBadge.classList.add("badge-green");
        } else {
            labelsBadge.classList.add("badge-red");
        }

        const shockType = shockTypeSelect.value;
        if (shockType === "none") {
            shockBadge.textContent = "No shock";
            shockBadge.className = "badge";
        } else {
            shockBadge.textContent = `${shockType.toUpperCase()} ${formatBps(parseFloat(shockInput.value) || 0)} bps`;
            shockBadge.className = "badge";
        }
    }

    function updateCharts(data) {
        const ts = data.time_series;
        const curve = data.curve;

        const dates = ts.dates;
        const shortY = ts.short_yields.map(v => v * 100);
        const longY = ts.long_yields.map(v => v * 100);
        const spread = ts.spread_bps;

        const ctxYields = document.getElementById("yieldsChart").getContext("2d");
        const ctxSpread = document.getElementById("spreadChart").getContext("2d");
        const ctxCurve = document.getElementById("curveChart").getContext("2d");

        if (yieldsChart) yieldsChart.destroy();
        if (spreadChart) spreadChart.destroy();
        if (curveChart) curveChart.destroy();

        yieldsChart = createLineChart(ctxYields, {
            data: {
                labels: dates,
                datasets: [
                    {
                        label: "Short yield",
                        data: shortY,
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.25)",
                        tension: 0.15,
                        pointRadius: 0
                    },
                    {
                        label: "Long yield",
                        data: longY,
                        borderColor: "#f97316",
                        backgroundColor: "rgba(249,115,22,0.25)",
                        tension: 0.15,
                        pointRadius: 0
                    }
                ]
            }
        });

        const spreadMean = spread.reduce((a, b) => a + b, 0) / spread.length;
        const spreadMeanArr = spread.map(() => spreadMean);

        spreadChart = createLineChart(ctxSpread, {
            data: {
                labels: dates,
                datasets: [
                    {
                        label: "Spread (bps)",
                        data: spread,
                        borderColor: "#22c55e",
                        backgroundColor: "rgba(34,197,94,0.25)",
                        tension: 0.15,
                        pointRadius: 0
                    },
                    {
                        label: "Mean",
                        data: spreadMeanArr,
                        borderColor: "#6b7280",
                        borderDash: [5, 5],
                        pointRadius: 0
                    }
                ]
            }
        });

        const grid = curve.grid;
        const spot = curve.spot.map(v => v * 100);
        const shock = curve.shock.map(v => v * 100);

        const showShock = shockTypeSelect.value !== "none";

        curveChart = new Chart(ctxCurve, {
            type: "line",
            data: {
                labels: grid,
                datasets: [
                    {
                        label: "Spot curve",
                        data: spot,
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.2)",
                        tension: 0.2,
                        pointRadius: 0
                    },
                    {
                        label: "Shocked curve",
                        data: showShock ? shock : [],
                        borderColor: "#ef4444",
                        backgroundColor: "rgba(239,68,68,0.2)",
                        tension: 0.2,
                        pointRadius: 0,
                        hidden: !showShock
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "index",
                    intersect: false
                },
                plugins: {
                    legend: {
                        labels: {
                            color: "#e5e7eb",
                            usePointStyle: true,
                            boxWidth: 6
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: "Maturity (years)",
                            color: "#9ca3af"
                        },
                        ticks: { color: "#9ca3af" },
                        grid: { color: "rgba(55,65,81,0.4)" }
                    },
                    y: {
                        title: {
                            display: true,
                            text: "Yield (%)",
                            color: "#9ca3af"
                        },
                        ticks: { color: "#9ca3af" },
                        grid: { color: "rgba(55,65,81,0.4)" }
                    }
                }
            }
        });
    }

    async function runAnalysis() {
        const shortVal = parseInt(shortSelect.value, 10);
        const longVal = parseInt(longSelect.value, 10);
        const start = startInput.value;
        const end = endInput.value;
        const shock = parseFloat(shockInput.value) || 0;
        const shockType = shockTypeSelect.value;

        if (!start || !end) {
            updateStatus("Please provide both start and end dates.", true);
            return;
        }
        if (shortVal >= longVal) {
            updateStatus("Short maturity must be less than long maturity.", true);
            return;
        }

        const payload = {
            short: shortVal,
            long: longVal,
            start: start,
            end: end,
            shock_bp: shock,
            shock_type: shockType
        };

        setLoading(true);
        try {
            const res = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) {
                const msg = data && data.error ? data.error : "Request failed";
                updateStatus(msg, true);
                return;
            }
            updateKPIs(data);
            updateCharts(data);
            updateStatus("OK");
        } catch (err) {
            updateStatus("Error: " + err, true);
        } finally {
            setLoading(false);
        }
    }

    function resetForm() {
        shortSelect.value = "2";
        longSelect.value = "10";
        startInput.value = "2023-01-01";
        endInput.value = "2024-12-01";
        shockInput.value = "10";
        shockTypeSelect.value = "parallel";
        updateStatus("Idle");
        kpiSpread.textContent = "–";
        kpiZ.textContent = "–";
        kpiPct.textContent = "–";
        kpi10Y.textContent = "–";
        kpiDV01.textContent = "–";
        labelsBadge.textContent = "–";
        labelsBadge.className = "badge";
        shockBadge.textContent = "No shock";
        shockBadge.className = "badge";
        if (yieldsChart) yieldsChart.destroy();
        if (spreadChart) spreadChart.destroy();
        if (curveChart) curveChart.destroy();
    }

    runButton.addEventListener("click", runAnalysis);
    resetButton.addEventListener("click", resetForm);

    // Optional: auto-run once
    window.addEventListener("load", () => {
        updateStatus("Idle");
    });
</script>
</body>
</html>
